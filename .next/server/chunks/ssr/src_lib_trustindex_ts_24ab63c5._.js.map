{"version":3,"sources":["../../../../src/lib/trustindex.ts"],"sourcesContent":["export const TRUSTINDEX_WIDGET_ID = \"d273c79511b386516c861cd858a\";\r\nexport const TRUSTINDEX_SCRIPT_SRC = `https://cdn.trustindex.io/loader.js?${TRUSTINDEX_WIDGET_ID}`;\r\n\r\ntype MountOptions = {\r\n  /** Only load the script when the widget scrolls near the viewport */\r\n  rootMargin?: string;\r\n  /** If true, load immediately without intersection gating */\r\n  immediate?: boolean;\r\n  /** Delay before loading the script after intersection */\r\n  delayMs?: number;\r\n  /** Called once the loader script is loaded (or already present) */\r\n  onLoaded?: () => void;\r\n};\r\n\r\nfunction runWhenIdle(cb: () => void, timeoutMs = 1500) {\r\n  const w = window as unknown as {\r\n    requestIdleCallback?: (fn: () => void, opts?: { timeout: number }) => number;\r\n    cancelIdleCallback?: (id: number) => void;\r\n  };\r\n\r\n  if (w.requestIdleCallback) {\r\n    const id = w.requestIdleCallback(cb, { timeout: timeoutMs });\r\n    return () => w.cancelIdleCallback?.(id);\r\n  }\r\n\r\n  const t = window.setTimeout(cb, 0);\r\n  return () => window.clearTimeout(t);\r\n}\r\n\r\nfunction ensureTrustindexScript(onLoaded?: () => void) {\r\n  const existing = document.querySelector<HTMLScriptElement>(\r\n    `script[src^=\"${TRUSTINDEX_SCRIPT_SRC}\"]`,\r\n  );\r\n\r\n  if (existing) {\r\n    console.info(\"[Trustindex] script already present\");\r\n    onLoaded?.();\r\n    return () => {};\r\n  }\r\n\r\n  console.info(\"[Trustindex] injecting script\", TRUSTINDEX_SCRIPT_SRC);\r\n  const script = document.createElement(\"script\");\r\n  script.src = TRUSTINDEX_SCRIPT_SRC;\r\n  script.async = true;\r\n  script.defer = true;\r\n  script.onload = () => onLoaded?.();\r\n  script.onerror = (e) => console.error(\"[Trustindex] script load error\", e);\r\n  document.body.appendChild(script);\r\n\r\n  return () => {\r\n    // Keep the script around once loaded to avoid churn; removing/re-adding can cause more work.\r\n  };\r\n}\r\n\r\nexport function mountTrustindexWidget(container: HTMLElement, options: MountOptions = {}) {\r\n  const { rootMargin = \"250px\", delayMs = 1200, onLoaded, immediate = false } = options;\r\n\r\n  const widgetDiv = document.createElement(\"div\");\r\n  widgetDiv.setAttribute(\"data-widget-id\", TRUSTINDEX_WIDGET_ID);\r\n  widgetDiv.className = \"trustindex-widget\";\r\n  container.appendChild(widgetDiv);\r\n  console.info(\"[Trustindex] widget div appended\");\r\n\r\n  let cancelled = false;\r\n  let cancelIdle: (() => void) | null = null;\r\n  let delayTimer: number | null = null;\r\n\r\n  const load = () => {\r\n    if (cancelled) return;\r\n    cancelIdle = runWhenIdle(() => {\r\n      if (cancelled) return;\r\n      ensureTrustindexScript(onLoaded);\r\n    });\r\n  };\r\n\r\n  if (immediate) {\r\n    console.info(\"[Trustindex] immediate load requested\");\r\n    delayTimer = window.setTimeout(load, delayMs);\r\n  } else {\r\n    const observer = new IntersectionObserver(\r\n      ([entry]) => {\r\n        if (!entry.isIntersecting) return;\r\n        observer.disconnect();\r\n        delayTimer = window.setTimeout(load, delayMs);\r\n      },\r\n      { rootMargin },\r\n    );\r\n\r\n    console.info(\"[Trustindex] observing for viewport\", { rootMargin });\r\n    observer.observe(container);\r\n  }\r\n\r\n  return () => {\r\n    cancelled = true;\r\n    // observer only exists when not immediate\r\n    // @ts-ignore\r\n    if (typeof observer !== \"undefined\") observer.disconnect();\r\n    if (delayTimer) window.clearTimeout(delayTimer);\r\n    cancelIdle?.();\r\n    widgetDiv.remove();\r\n  };\r\n}\r\n\r\n\r\n"],"names":[],"mappings":"sCAAO,IAAM,EAAuB,8BACvB,EAAwB,CAAC,oCAAoC,EAAE,EAAA,CAAsB,CAqD3F,SAAS,EAAsB,CAAsB,CAAE,EAAwB,CAAC,CAAC,EACtF,GAAM,YAAE,EAAa,OAAO,CAAE,UAAU,IAAI,UAAE,CAAQ,WAAE,GAAY,CAAK,CAAE,CAAG,EAExE,EAAY,SAAS,aAAa,CAAC,OACzC,EAAU,YAAY,CAAC,iBAAkB,GACzC,EAAU,SAAS,CAAG,oBACtB,EAAU,WAAW,CAAC,GACtB,QAAQ,IAAI,CAAC,oCAEb,IAAI,GAAY,EACZ,EAAkC,KAClC,EAA4B,KAE1B,EAAO,KACP,IACJ,EAvDJ,AAuDiB,KADE,IAtDV,AAAY,CAAc,CAAE,EAAY,IAAI,EACnD,IAAM,EAAI,OAKV,GAAI,EAAE,mBAAmB,CAAE,CACzB,IAAM,EAAK,EAAE,mBAAmB,CAAC,EAAI,CAAE,QAAS,CAAU,GAC1D,MAAO,IAAM,EAAE,kBAAkB,GAAG,EACtC,CAEA,IAAM,EAAI,OAAO,UAAU,CAAC,EAAI,GAChC,MAAO,IAAM,OAAO,YAAY,CAAC,EACnC,EA0C6B,KACnB,GACJ,AA1CN,QAyCqB,CAzCW,AAAvB,CAA4C,EAKnD,GAJiB,CAIb,QAJsB,EAIZ,WAJyB,CACrC,CAAC,aAAa,EAAE,EAAsB,EAAE,CAAC,EAMzC,OAFA,QAAQ,IAAI,CAAC,uCACb,MACO,KAAO,EAGhB,QAAQ,IAAI,CAAC,gCAAiC,GAC9C,IAAM,EAAS,SAAS,aAAa,CAAC,SACtC,GAAO,GAAG,CAAG,EACb,EAAO,KAAK,EAAG,EACf,EAAO,KAAK,EAAG,EACf,EAAO,MAAM,CAAG,IAAM,MACtB,EAAO,OAAO,CAAG,AAAC,GAAM,QAAQ,KAAK,CAAC,iCAAkC,GACxE,SAAS,IAAI,CAAC,WAAW,CAAC,GAEnB,KAEP,CACF,EAmB6B,EACzB,EAAA,CACF,EAEA,GAAI,EACF,QAAQ,CADK,GACD,CAAC,yCACb,EAAa,OAAO,UAAU,CAAC,EAAM,OAChC,CACL,IAAM,EAAW,IAAI,qBACnB,CAAC,CAAC,EAAM,IACD,EAAM,cAAc,EAAE,CAC3B,EAAS,UAAU,GACnB,EAAa,OAAO,UAAU,CAAC,EAAM,GACvC,EACA,YAAE,CAAW,GAGf,QAAQ,IAAI,CAAC,sCAAuC,YAAE,CAAW,GACjE,EAAS,OAAO,CAAC,EACnB,CAEA,MAAO,KACL,GAAY,EAGY,aAApB,OAAO,UAA0B,SAAS,UAAU,GACpD,GAAY,OAAO,YAAY,CAAC,GACpC,MACA,EAAU,MAAM,EAClB,CACF"}