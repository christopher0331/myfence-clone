{"version":3,"sources":["../../../../src/lib/trustindex.ts"],"sourcesContent":["export const TRUSTINDEX_WIDGET_ID = \"d273c79511b386516c861cd858a\";\nexport const TRUSTINDEX_SCRIPT_SRC = `https://cdn.trustindex.io/loader.js?${TRUSTINDEX_WIDGET_ID}`;\n\ntype MountOptions = {\n  /** Only load the script when the widget scrolls near the viewport */\n  rootMargin?: string;\n  /** Delay before loading the script after intersection */\n  delayMs?: number;\n  /** Called once the loader script is loaded (or already present) */\n  onLoaded?: () => void;\n};\n\nfunction runWhenIdle(cb: () => void, timeoutMs = 1500) {\n  const w = window as unknown as {\n    requestIdleCallback?: (fn: () => void, opts?: { timeout: number }) => number;\n    cancelIdleCallback?: (id: number) => void;\n  };\n\n  if (w.requestIdleCallback) {\n    const id = w.requestIdleCallback(cb, { timeout: timeoutMs });\n    return () => w.cancelIdleCallback?.(id);\n  }\n\n  const t = window.setTimeout(cb, 0);\n  return () => window.clearTimeout(t);\n}\n\nfunction ensureTrustindexScript(onLoaded?: () => void) {\n  const existing = document.querySelector<HTMLScriptElement>(\n    `script[src^=\"${TRUSTINDEX_SCRIPT_SRC}\"]`,\n  );\n\n  if (existing) {\n    onLoaded?.();\n    return () => {};\n  }\n\n  const script = document.createElement(\"script\");\n  script.src = TRUSTINDEX_SCRIPT_SRC;\n  script.async = true;\n  script.defer = true;\n  script.onload = () => onLoaded?.();\n  document.body.appendChild(script);\n\n  return () => {\n    // Keep the script around once loaded to avoid churn; removing/re-adding can cause more work.\n  };\n}\n\nexport function mountTrustindexWidget(container: HTMLElement, options: MountOptions = {}) {\n  const { rootMargin = \"250px\", delayMs = 1200, onLoaded } = options;\n\n  const widgetDiv = document.createElement(\"div\");\n  widgetDiv.setAttribute(\"data-widget-id\", TRUSTINDEX_WIDGET_ID);\n  widgetDiv.className = \"trustindex-widget\";\n  container.appendChild(widgetDiv);\n\n  let cancelled = false;\n  let cancelIdle: (() => void) | null = null;\n  let delayTimer: number | null = null;\n\n  const load = () => {\n    if (cancelled) return;\n    cancelIdle = runWhenIdle(() => {\n      if (cancelled) return;\n      ensureTrustindexScript(onLoaded);\n    });\n  };\n\n  const observer = new IntersectionObserver(\n    ([entry]) => {\n      if (!entry.isIntersecting) return;\n      observer.disconnect();\n      delayTimer = window.setTimeout(load, delayMs);\n    },\n    { rootMargin },\n  );\n\n  observer.observe(container);\n\n  return () => {\n    cancelled = true;\n    observer.disconnect();\n    if (delayTimer) window.clearTimeout(delayTimer);\n    cancelIdle?.();\n    widgetDiv.remove();\n  };\n}\n\n\n"],"names":[],"mappings":"sCAAO,IAAM,EAAuB,8BACvB,EAAwB,CAAC,oCAAoC,EAAE,EAAA,CAAsB,CAgD3F,SAAS,EAAsB,CAAsB,CAAE,EAAwB,CAAC,CAAC,EACtF,GAAM,YAAE,EAAa,OAAO,SAAE,EAAU,IAAI,CAAE,UAAQ,CAAE,CAAG,EAErD,EAAY,SAAS,aAAa,CAAC,OACzC,EAAU,YAAY,CAAC,iBAAkB,GACzC,EAAU,SAAS,CAAG,oBACtB,EAAU,WAAW,CAAC,GAEtB,IAAI,GAAY,EACZ,EAAkC,KAClC,EAA4B,KAE1B,EAAO,KACP,IACJ,EAnDJ,AAmDiB,KADE,IAlDE,AAAZ,CAA0B,CAAE,EAAY,IAAI,EACnD,IAAM,EAAI,OAKV,GAAI,EAAE,mBAAmB,CAAE,CACzB,IAAM,EAAK,EAAE,mBAAmB,CAAC,EAAI,CAAE,QAAS,CAAU,GAC1D,MAAO,IAAM,EAAE,kBAAkB,GAAG,EACtC,CAEA,IAAM,EAAI,OAAO,UAAU,CAAC,EAAI,GAChC,MAAO,IAAM,OAAO,YAAY,CAAC,EACnC,EAsC6B,KACnB,GACJ,AAtCN,QAqCqB,CArCZ,AAAuB,CAAqB,EAKnD,GAJiB,CAIb,QAJsB,EAIZ,WAJyB,CACrC,CAAC,aAAa,EAAE,EAAsB,EAAE,CAAC,EAKzC,OADA,MACO,KAAO,EAGhB,IAAM,EAAS,SAAS,aAAa,CAAC,UACtC,EAAO,GAAG,CAAG,EACb,EAAO,KAAK,EAAG,EACf,EAAO,KAAK,EAAG,EACf,EAAO,MAAM,CAAG,IAAM,MACtB,SAAS,IAAI,CAAC,WAAW,CAAC,GAEnB,KAEP,CACF,EAkB6B,EACzB,EAAA,CACF,EAEM,EAAW,IAAI,qBACnB,CAAC,CAAC,EAAM,IACD,EAAM,cAAc,EAAE,CAC3B,EAAS,UAAU,GACnB,EAAa,OAAO,UAAU,CAAC,EAAM,GACvC,EACA,YAAE,CAAW,GAKf,OAFA,EAAS,OAAO,CAAC,GAEV,KACL,GAAY,EACZ,EAAS,UAAU,GACf,GAAY,OAAO,YAAY,CAAC,GACpC,MACA,EAAU,MAAM,EAClB,CACF"}