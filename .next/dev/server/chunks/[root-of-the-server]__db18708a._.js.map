{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/dev/repos/myfence-clone/src/app/api/website-lead/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\n\r\nconst DEFAULT_WEBHOOK_URL =\r\n  \"https://mdcbcpowsrrebtustwwp.supabase.co/functions/v1/receive-website-lead-webhook\";\r\n\r\nfunction toStringOrEmpty(v: unknown): string {\r\n  if (typeof v === \"string\") return v;\r\n  if (v == null) return \"\";\r\n  return String(v);\r\n}\r\n\r\nfunction parseAddressParts(input: string): {\r\n  address: string;\r\n  city: string;\r\n  state: string;\r\n  zip: string;\r\n} {\r\n  const raw = (input || \"\").trim();\r\n  if (!raw) return { address: \"\", city: \"\", state: \"\", zip: \"\" };\r\n\r\n  // Heuristic parse:\r\n  // \"123 Main St, Seattle, WA 98101\"\r\n  const parts = raw.split(\",\").map((p) => p.trim()).filter(Boolean);\r\n\r\n  const address = parts[0] ?? raw;\r\n  const city = parts[1] ?? \"\";\r\n\r\n  let state = \"\";\r\n  let zip = \"\";\r\n  const stateZip = parts[2] ?? \"\";\r\n  if (stateZip) {\r\n    const tokens = stateZip.split(/\\s+/).filter(Boolean);\r\n    state = tokens[0] ?? \"\";\r\n    zip = tokens[1] ?? \"\";\r\n  }\r\n\r\n  return { address, city, state, zip };\r\n}\r\n\r\nexport async function POST(req: Request) {\r\n  const apiKey = process.env.WEBSITE_LEADS_API;\r\n  if (!apiKey) {\r\n    return NextResponse.json(\r\n      // Return 200 so clients can gracefully fall back to the legacy email flow without noisy 500s in dev.\r\n      { ok: false, error: \"Missing server env var WEBSITE_LEADS_API\" },\r\n      { status: 200 },\r\n    );\r\n  }\r\n\r\n  const webhookUrl = process.env.WEBSITE_LEADS_WEBHOOK_URL || DEFAULT_WEBHOOK_URL;\r\n\r\n  let body: any;\r\n  try {\r\n    body = await req.json();\r\n  } catch {\r\n    return NextResponse.json({ ok: false, error: \"Invalid JSON\" }, { status: 400 });\r\n  }\r\n\r\n  // Accept either snake_case or camelCase from the client\r\n  const firstName = toStringOrEmpty(body.first_name ?? body.firstName);\r\n  const lastName = toStringOrEmpty(body.last_name ?? body.lastName);\r\n  const email = toStringOrEmpty(body.email);\r\n  const phone = toStringOrEmpty(body.phone);\r\n\r\n  const addressInput = toStringOrEmpty(body.address);\r\n  const parsed = parseAddressParts(addressInput);\r\n\r\n  const city = toStringOrEmpty(body.city) || parsed.city;\r\n  const state = toStringOrEmpty(body.state) || parsed.state;\r\n  const zip = toStringOrEmpty(body.zip) || parsed.zip;\r\n\r\n  const fenceType = toStringOrEmpty(body.fence_type ?? body.fenceType);\r\n  const message = toStringOrEmpty(body.message ?? body.description ?? body.projectDescription ?? body.notes);\r\n\r\n  const payload = {\r\n    first_name: firstName,\r\n    last_name: lastName,\r\n    email,\r\n    phone,\r\n    address: parsed.address || addressInput,\r\n    city,\r\n    state,\r\n    zip,\r\n    fence_type: fenceType,\r\n    message,\r\n  };\r\n\r\n  try {\r\n    const res = await fetch(webhookUrl, {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"content-type\": \"application/json\",\r\n        \"x-api-key\": apiKey,\r\n      },\r\n      body: JSON.stringify(payload),\r\n    });\r\n\r\n    if (!res.ok) {\r\n      const text = await res.text().catch(() => \"\");\r\n      return NextResponse.json(\r\n        // Return 200 so clients can gracefully fall back to the legacy email flow.\r\n        { ok: false, error: `Webhook failed (${res.status})`, details: text.slice(0, 500) },\r\n        { status: 200 },\r\n      );\r\n    }\r\n\r\n    return NextResponse.json({ ok: true });\r\n  } catch (e) {\r\n    return NextResponse.json(\r\n      // Return 200 so clients can gracefully fall back to the legacy email flow.\r\n      { ok: false, error: \"Failed to reach webhook\", details: e instanceof Error ? e.message : String(e) },\r\n      { status: 200 },\r\n    );\r\n  }\r\n}\r\n\r\n\r\n"],"names":[],"mappings":"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"}}]
}